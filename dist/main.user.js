// ==UserScript==
// @name        慕课 Hack
// @version     0.0.1
// @include     https://www.icourse163.org/learn/*
// @downloadURL https://github.com/CUC-Life-Hack/icourse163-hack/raw/master/dist/main.user.js
// @grant       unsafeWindow
// @run-at      document-start
// ==/UserScript==

/*! For license information please see main.js.LICENSE.txt */
(()=>{"use strict";var e={762:(e,t,n)=>{n.d(t,{Z:()=>a});var r=n(81),o=n.n(r),i=n(645),s=n.n(i)()(o());s.push([e.id,"#hack{--border-color:#666;display:flex;flex-direction:column;z-index:10000;position:fixed;box-sizing:border-box;overflow:auto;margin:1em;padding:1em;right:0;top:0;width:400px;height:300px;border:1px solid var(--border-color);background-color:rgba(255,255,255,0.8);box-shadow:0 .25em .75em rgba(0,0,0,0.267)}#hack >header{display:block;border-bottom:1px solid var(--border-color);margin-bottom:.5em;font-size:1.4em;font-weight:600}#hack >main{flex-grow:1}#hack .log{display:block;font-size:.8em;text-align:left;height:6em;max-height:6em;overflow-y:auto;border:1px solid;font-family:monospace,sans-serif}#hack .log >*{margin:0}#hack .log >.warning{background-color:#ffffe0;color:#8b0000}",""]);const a=s},645:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",r=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),r&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),r&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,r,o,i){"string"==typeof e&&(e=[[null,e,void 0]]);var s={};if(r)for(var a=0;a<this.length;a++){var c=this[a][0];null!=c&&(s[c]=!0)}for(var u=0;u<e.length;u++){var l=[].concat(e[u]);r&&s[l[0]]||(void 0!==i&&(void 0===l[5]||(l[1]="@layer".concat(l[5].length>0?" ".concat(l[5]):""," {").concat(l[1],"}")),l[5]=i),n&&(l[2]?(l[1]="@media ".concat(l[2]," {").concat(l[1],"}"),l[2]=n):l[2]=n),o&&(l[4]?(l[1]="@supports (".concat(l[4],") {").concat(l[1],"}"),l[4]=o):l[4]="".concat(o)),t.push(l))}},t}},81:e=>{e.exports=function(e){return e[1]}},379:e=>{var t=[];function n(e){for(var n=-1,r=0;r<t.length;r++)if(t[r].identifier===e){n=r;break}return n}function r(e,r){for(var i={},s=[],a=0;a<e.length;a++){var c=e[a],u=r.base?c[0]+r.base:c[0],l=i[u]||0,f="".concat(u," ").concat(l);i[u]=l+1;var p=n(f),d={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==p)t[p].references++,t[p].updater(d);else{var h=o(d,r);r.byIndex=a,t.splice(a,0,{identifier:f,updater:h,references:1})}s.push(f)}return s}function o(e,t){var n=t.domAPI(t);return n.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,o){var i=r(e=e||[],o=o||{});return function(e){e=e||[];for(var s=0;s<i.length;s++){var a=n(i[s]);t[a].references--}for(var c=r(e,o),u=0;u<i.length;u++){var l=n(i[u]);0===t[l].references&&(t[l].updater(),t.splice(l,1))}i=c}}},569:e=>{var t={};e.exports=function(e,n){var r=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(n)}},216:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},565:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},795:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var r="";n.supports&&(r+="@supports (".concat(n.supports,") {")),n.media&&(r+="@media ".concat(n.media," {"));var o=void 0!==n.layer;o&&(r+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),r+=n.css,o&&(r+="}"),n.media&&(r+="}"),n.supports&&(r+="}");var i=n.sourceMap;i&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),t.styleTagTransform(r,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},589:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},452:e=>{var t,n="object"==typeof Reflect?Reflect:null,r=n&&"function"==typeof n.apply?n.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};t=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var o=Number.isNaN||function(e){return e!=e};function i(){i.init.call(this)}e.exports=i,e.exports.once=function(e,t){return new Promise((function(n,r){function o(n){e.removeListener(t,i),r(n)}function i(){"function"==typeof e.removeListener&&e.removeListener("error",o),n([].slice.call(arguments))}v(e,t,i,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&v(e,"error",t,{once:!0})}(e,o)}))},i.EventEmitter=i,i.prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var s=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function c(e){return void 0===e._maxListeners?i.defaultMaxListeners:e._maxListeners}function u(e,t,n,r){var o,i,s,u;if(a(n),void 0===(i=e._events)?(i=e._events=Object.create(null),e._eventsCount=0):(void 0!==i.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),i=e._events),s=i[t]),void 0===s)s=i[t]=n,++e._eventsCount;else if("function"==typeof s?s=i[t]=r?[n,s]:[s,n]:r?s.unshift(n):s.push(n),(o=c(e))>0&&s.length>o&&!s.warned){s.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=s.length,u=l,console&&console.warn&&console.warn(u)}return e}function l(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function f(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},o=l.bind(r);return o.listener=n,r.wrapFn=o,o}function p(e,t,n){var r=e._events;if(void 0===r)return[];var o=r[t];return void 0===o?[]:"function"==typeof o?n?[o.listener||o]:[o]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(o):h(o,o.length)}function d(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function h(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function v(e,t,n,r){if("function"==typeof e.on)r.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function o(i){r.once&&e.removeEventListener(t,o),n(i)}))}}Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return s},set:function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");s=e}}),i.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},i.prototype.getMaxListeners=function(){return c(this)},i.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var o="error"===e,i=this._events;if(void 0!==i)o=o&&void 0===i.error;else if(!o)return!1;if(o){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var c=i[e];if(void 0===c)return!1;if("function"==typeof c)r(c,this,t);else{var u=c.length,l=h(c,u);for(n=0;n<u;++n)r(l[n],this,t)}return!0},i.prototype.addListener=function(e,t){return u(this,e,t,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(e,t){return u(this,e,t,!0)},i.prototype.once=function(e,t){return a(t),this.on(e,f(this,e,t)),this},i.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,f(this,e,t)),this},i.prototype.removeListener=function(e,t){var n,r,o,i,s;if(a(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(o=-1,i=n.length-1;i>=0;i--)if(n[i]===t||n[i].listener===t){s=n[i].listener,o=i;break}if(o<0)return this;0===o?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,o),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,s||t)}return this},i.prototype.off=i.prototype.removeListener,i.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var o,i=Object.keys(n);for(r=0;r<i.length;++r)"removeListener"!==(o=i[r])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},i.prototype.listeners=function(e){return p(this,e,!0)},i.prototype.rawListeners=function(e){return p(this,e,!1)},i.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):d.call(e,t)},i.prototype.listenerCount=d,i.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={id:r,exports:{}};return e[r](i,i.exports,n),i.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nc=void 0,(()=>{const e=unsafeWindow||(window?window.wrappedJSObject||window:null);var t=n(452);const r=HTMLElement.prototype.addEventListener;function o(e,t){const n=document.createElement(e);return t&&function(e,t){if(t.id&&(e.id=t.id),t.classes?.length&&(t.classes instanceof Array?e.classList.add(...t.classes):e.classList.add(t.classes)),t.attributes)for(const[n,r]of Object.entries(t.attributes))e.setAttribute(n,r);if(t.rawAttributes)for(const[n,r]of Object.entries(t.rawAttributes))e[n]=r;if(t.html&&(e.innerHTML=t.html),t.text&&(e.innerText=t.text),t.parent&&t.parent.appendChild(e),t.children&&(t.children instanceof Array?e.append(...t.children):e.append(t.children)),t.on)for(const n in t.on)r.call(e,n,t.on[n]);if(t.once)for(const n in t.once)r.call(e,n,t.once[n],{once:!0});if(t.styles)for(const[n,r]of Object.entries(t.styles))e.style[n]=r;if(t.cssVars)for(const[n,r]of Object.entries(t.cssVars))e.style.setProperty(n,r)}(n,t),n}var i=n(379),s=n.n(i),a=n(795),c=n.n(a),u=n(569),l=n.n(u),f=n(565),p=n.n(f),d=n(216),h=n.n(d),v=n(589),m=n.n(v),y=n(762),g={};g.styleTagTransform=m(),g.setAttributes=p(),g.insert=l().bind(null,"head"),g.domAPI=c(),g.insertStyleElement=h(),s()(y.Z,g),y.Z&&y.Z.locals&&y.Z.locals;class b{root=o("aside",{id:"hack"});#e=o("header",{parent:this.root});content=o("main",{parent:this.root});#t=o("aside",{parent:this.root,classes:"log"});get title(){return this.#e.innerText}set title(e){this.#e.innerText=e}Clear(){!function(e){for(const t of Array.from(e.childNodes))e.removeChild(t)}(this.content)}Log(e,...t){this.#t.appendChild(o("p",{text:e,classes:t}))}Add(...e){this.content.append(...e)}Button(e,t){const n=o("button",{text:e,on:{click:t}});return this.Add(n),n}}function w(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)e[r]=n[r]}return e}const L=function e(t,n){function r(e,r,o){if("undefined"!=typeof document){"number"==typeof(o=w({},n,o)).expires&&(o.expires=new Date(Date.now()+864e5*o.expires)),o.expires&&(o.expires=o.expires.toUTCString()),e=encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var i="";for(var s in o)o[s]&&(i+="; "+s,!0!==o[s]&&(i+="="+o[s].split(";")[0]));return document.cookie=e+"="+t.write(r,e)+i}}return Object.create({set:r,get:function(e){if("undefined"!=typeof document&&(!arguments.length||e)){for(var n=document.cookie?document.cookie.split("; "):[],r={},o=0;o<n.length;o++){var i=n[o].split("="),s=i.slice(1).join("=");try{var a=decodeURIComponent(i[0]);if(r[a]=t.read(s,a),e===a)break}catch(e){}}return e?r[e]:r}},remove:function(e,t){r(e,"",w({},t,{expires:-1}))},withAttributes:function(t){return e(this.converter,w({},this.attributes,t))},withConverter:function(t){return e(w({},this.converter,t),this.attributes)}},{attributes:{value:Object.freeze(n)},converter:{value:Object.freeze(t)}})}({read:function(e){return'"'===e[0]&&(e=e.slice(1,-1)),e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(e){return encodeURIComponent(e).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}},{path:"/"});class x{url;timeout=0;method="GET";header=new Map;searchParams=new Map;payload=null;constructor(t,n="GET"){this.url=t instanceof URL?t:new URL(t,e.location.href),this.method=n}async Post(){const e=new XMLHttpRequest,t=new URL(this.url);this.timeout>0&&(e.timeout=this.timeout);for(const[t,n]of this.header)e.setRequestHeader(t,n);for(const[e,n]of this.searchParams)t.searchParams.append(e,n);return e.open(this.method,t.toString()),"string"==typeof this.payload?e.send(this.payload):e.send(),await Promise.race([new Promise((t=>e.ontimeout=()=>t(Promise.reject(new Error("Request timed out"))))),new Promise((t=>e.onerror=e=>t(Promise.reject(e)))),new Promise((t=>e.onload=()=>t(Promise.resolve(e.responseText))))])}}const C=new class{life=new t.EventEmitter;panel=new b;#n=e.location.href;#r;#o;get urlChangeDetectionTimestep(){return this.#r}set urlChangeDetectionTimestep(t){clearTimeout(this.#o),this.#r=t,t<=0||(this.#o=setTimeout((()=>{const n=e.location.href;n!==this.#n&&(this.#n=n,this.life.emit("urlchange",{hack:this,url:new URL(n)})),this.urlChangeDetectionTimestep=t}),t))}constructor(){var e;e=()=>document.body.appendChild(this.panel.root),"complete"===document.readyState?Promise.resolve(e()):new Promise((t=>{document.addEventListener("readystatechange",(()=>t(e())),{once:!0})})),this.urlChangeDetectionTimestep=100,setTimeout((()=>{this.life.emit("start",{hack:this}),this.life.emit("urlchange",{hack:this,url:new URL(this.#n)})}))}};C.life.on("start",(function(){C.panel.title="慕课 Hack",r.toString().includes("native code")||C.panel.Log("addEventListener 已被劫持！","warning")}));class P extends x{static cookieName="AjaxWithCsrf";Post(){const e=L.get(P.cookieName);if(!e||!/^[a-f\d]+$/.test(e))throw"Invalid CSRF key";return this.searchParams.set("csrfKey",e),super.Post()}}const T={sectionId:"",contentId:""};async function E(){C.panel.Log("正在完成分页课件");const e={dto:{unitId:T.contentId,pageNum:-1,finished:!0,contentType:3}},t=new P("/web/j/courseRpcBean.saveMocContentLearn.rpc","POST");t.payload=JSON.stringify(e);try{if(!0!==JSON.parse(await t.Post()).result)throw"完成失败"}catch(e){return void C.panel.Log(e+"")}C.panel.Log("完成成功")}const _=[{validate(e){try{const t=new URL(`http://domain${e.hash.slice(1)}`);if("/learn/content"!==t.pathname)throw'Path name is not "/learn/content".';if("detail"!==t.searchParams.get("type"))throw'Content type is not "detail".';if(!t.searchParams.has("id"))throw"URL lacks section ID.";T.sectionId=t.searchParams.get("id"),t.searchParams.has("cid")&&(T.contentId=t.searchParams.get("cid"))}catch(e){return C.panel.Log(e+""),!1}return!0},load(){C.panel.Clear(),C.panel.Log(`id=${T.sectionId}, cid=${T.contentId}`),C.panel.Button("完成分页课件",E)}}];C.life.on("urlchange",(function({url:e}){for(const t of _)if(t.validate(e)){t.load();break}}))})()})();